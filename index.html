<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anywhere Rooter Sales Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyD9POKxbl9hSt2FNtzdv3RPVnAb0wWsNbU",
            authDomain: "action-sales-tracker.firebaseapp.com",
            databaseURL: "https://action-sales-tracker-default-rtdb.firebaseio.com",
            projectId: "action-sales-tracker",
            storageBucket: "action-sales-tracker.firebasestorage.app",
            messagingSenderId: "686455834332",
            appId: "1:686455834332:web:84e9b843f912522bbdd619"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            const [salespeople, setSalespeople] = useState([]);
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [callLogs, setCallLogs] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [newPersonName, setNewPersonName] = useState('');
            const [showAddPerson, setShowAddPerson] = useState(false);
            const [monthlyGoals, setMonthlyGoals] = useState({});
            const [yearlyGoals, setYearlyGoals] = useState({});
            const [teamMonthlyGoal, setTeamMonthlyGoal] = useState(0);
            const [loading, setLoading] = useState(true);
            const [showOutstandingJobs, setShowOutstandingJobs] = useState(false);
            const dailyChartRef = useRef(null);
            const tradeChartRef = useRef(null);
            const dailyChartInstance = useRef(null);
            const tradeChartInstance = useRef(null);

            useEffect(() => {
                const ref = database.ref('salespeople');
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const peopleArray = Object.keys(data).map(key => ({
                            id: key,
                            name: data[key].name
                        }));
                        setSalespeople(peopleArray);
                        if (!selectedPerson && peopleArray.length > 0) {
                            setSelectedPerson(peopleArray[0].id);
                        }
                    }
                    setLoading(false);
                });
                return () => ref.off();
            }, []);

            useEffect(() => {
                const ref = database.ref('callLogs');
                ref.on('value', (snapshot) => {
                    setCallLogs(snapshot.val() || {});
                });
                return () => ref.off();
            }, []);

            useEffect(() => {
                const monthlyRef = database.ref('monthlyGoals');
                monthlyRef.on('value', (snapshot) => setMonthlyGoals(snapshot.val() || {}));

                const yearlyRef = database.ref('yearlyGoals');
                yearlyRef.on('value', (snapshot) => setYearlyGoals(snapshot.val() || {}));

                const teamMonthlyRef = database.ref('teamMonthlyGoal');
                teamMonthlyRef.on('value', (snapshot) => setTeamMonthlyGoal(snapshot.val() || 0));

                return () => {
                    monthlyRef.off();
                    yearlyRef.off();
                    teamMonthlyRef.off();
                };
            }, []);

            const addSalesperson = () => {
                if (newPersonName.trim()) {
                    database.ref('salespeople').push().set({ name: newPersonName.trim() });
                    setNewPersonName('');
                    setShowAddPerson(false);
                }
            };

            const removeSalesperson = (id) => {
                const person = salespeople.find(p => p.id === id);
                if (window.confirm(`Remove ${person.name}? This will delete all their data.`)) {
                    database.ref(`salespeople/${id}`).remove();
                    if (selectedPerson === id) setSelectedPerson(null);
                }
            };

            const getWeekDates = (date) => {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(date);
                monday.setDate(diff);
                const week = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    week.push(d);
                }
                return week;
            };

            const getDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const getDataKey = (personId, date) => `${personId}_${getDateKey(date)}`;
            const getMonthKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const getYearKey = (date) => `${date.getFullYear()}`;
            
            const weekDates = useMemo(() => getWeekDates(currentDate), [currentDate]);

            const addCall = (personId, date) => {
                const key = getDataKey(personId, date);
                database.ref(`callLogs/${key}`).push().set({
                    customerName: '',
                    jobNumber: '',
                    reviewCompleted: false,
                    restorationLead: false,
                    turnoverAttempted: false,
                    turnoverAccepted: false,
                    selfGeneratedLead: false,
                    stickers: false,
                    maintenancePlanSold: false,
                    upsellCompleted: false,
                    upsellAmount: 0,
                    jobComplete: false,
                    jobSold: false,
                    amountSold: 0,
                    amountCollected: 0,
                    leftEstimate: false,
                    estimateAmount: 0,
                    tradePlumbing: false,
                    tradeHVAC: false,
                    tradeElectrical: false,
                    tradeCameras: false,
                    paymentFinancing: false,
                    paymentCash: false,
                    paymentCheck: false,
                    paymentCreditCard: false,
                    timestamp: Date.now()
                });
            };

            const updateCall = (personId, date, callId, field, value) => {
                const key = getDataKey(personId, date);
                database.ref(`callLogs/${key}/${callId}/${field}`).set(value);
            };

            const deleteCall = (personId, date, callId) => {
                const key = getDataKey(personId, date);
                if (window.confirm('Delete this call?')) {
                    database.ref(`callLogs/${key}/${callId}`).remove();
                }
            };

            const getCallLogs = (personId, date) => {
                const key = getDataKey(personId, date);
                const logs = callLogs[key];
                if (!logs) return [];
                return Object.keys(logs).map(id => ({ id, ...logs[id] }));
            };

            const getMonthDates = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const dates = [];
                const lastDay = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= lastDay; day++) dates.push(new Date(year, month, day));
                return dates;
            };

            const getYearDates = (year) => {
                const dates = [];
                for (let month = 0; month < 12; month++) {
                    const monthDates = getMonthDates(new Date(year, month, 1));
                    dates.push(...monthDates);
                }
                return dates;
            };

            const calculateTotals = (personId, dates) => {
                const totals = {
                    totalCalls: 0,
                    callsSold: 0,
                    amountSold: 0,
                    amountCollected: 0,
                    moneyOwed: 0,
                    selfGenLeads: 0,
                    reviewsCompleted: 0,
                    turnoversAttempted: 0,
                    turnoversAccepted: 0,
                    stickers: 0,
                    restorationLeads: 0,
                    plansSold: 0,
                    upsellsCompleted: 0,
                    upsellAmount: 0,
                    estimatesLeft: 0,
                    estimateValue: 0,
                    estimatesNotSold: 0,
                    estimatesNotSoldValue: 0,
                    tradePlumbing: 0,
                    tradeHVAC: 0,
                    tradeElectrical: 0,
                    tradeCameras: 0,
                    jobsComplete: 0,
                    financingCount: 0,
                    cashCount: 0,
                    checkCount: 0,
                    creditCardCount: 0,
                    dailyBreakdown: {},
                    outstandingJobs: []
                };
                
                dates.forEach(date => {
                    const calls = getCallLogs(personId, date);
                    const dateKey = getDateKey(date);
                    totals.dailyBreakdown[dateKey] = { calls: 0, sold: 0, revenue: 0 };
                    
                    calls.forEach(c => {
                        totals.totalCalls++;
                        totals.dailyBreakdown[dateKey].calls++;
                        
                        if (c.jobSold) {
                            totals.callsSold++;
                            totals.dailyBreakdown[dateKey].sold++;
                            const amount = parseFloat(c.amountSold) || 0;
                            const collected = parseFloat(c.amountCollected) || 0;
                            const owed = amount - collected;
                            
                            totals.amountSold += amount;
                            totals.amountCollected += collected;
                            totals.moneyOwed += owed;
                            totals.dailyBreakdown[dateKey].revenue += amount;
                            
                            if (owed > 0) {
                                totals.outstandingJobs.push({
                                    customerName: c.customerName || 'No Name',
                                    jobNumber: c.jobNumber || 'No Job #',
                                    date: date,
                                    amountSold: amount,
                                    amountCollected: collected,
                                    amountOwed: owed
                                });
                            }
                        }
                        
                        if (c.selfGeneratedLead) totals.selfGenLeads++;
                        if (c.reviewCompleted) totals.reviewsCompleted++;
                        if (c.turnoverAttempted) totals.turnoversAttempted++;
                        if (c.turnoverAccepted) totals.turnoversAccepted++;
                        if (c.stickers) totals.stickers++;
                        if (c.restorationLead) totals.restorationLeads++;
                        if (c.maintenancePlanSold) totals.plansSold++;
                        if (c.upsellCompleted) {
                            totals.upsellsCompleted++;
                            totals.upsellAmount += parseFloat(c.upsellAmount) || 0;
                        }
                        if (c.leftEstimate) {
                            totals.estimatesLeft++;
                            const estAmount = parseFloat(c.estimateAmount) || 0;
                            totals.estimateValue += estAmount;
                            if (!c.jobSold) {
                                totals.estimatesNotSold++;
                                totals.estimatesNotSoldValue += estAmount;
                            }
                        }
                        if (c.tradePlumbing) totals.tradePlumbing++;
                        if (c.tradeHVAC) totals.tradeHVAC++;
                        if (c.tradeElectrical) totals.tradeElectrical++;
                        if (c.tradeCameras) totals.tradeCameras++;
                        if (c.jobComplete) totals.jobsComplete++;
                        if (c.paymentFinancing) totals.financingCount++;
                        if (c.paymentCash) totals.cashCount++;
                        if (c.paymentCheck) totals.checkCount++;
                        if (c.paymentCreditCard) totals.creditCardCount++;
                    });
                });
                
                return totals;
            };

            const getTodayStats = () => {
                const today = new Date();
                let totalCalls = 0;
                let totalRevenue = 0;
                salespeople.forEach(person => {
                    const calls = getCallLogs(person.id, today);
                    totalCalls += calls.length;
                    totalRevenue += calls.reduce((sum, c) => sum + (parseFloat(c.amountSold) || 0), 0);
                });
                return { totalCalls, totalRevenue };
            };

            const getStreak = (personId) => {
                let streak = 0;
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const calls = getCallLogs(personId, date);
                    const hasSale = calls.some(c => c.jobSold);
                    if (hasSale) {
                        streak++;
                    } else if (i > 0) {
                        break;
                    }
                }
                return streak;
            };

            const getDaysSinceLastSale = (personId) => {
                const today = new Date();
                for (let i = 0; i < 90; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const calls = getCallLogs(personId, date);
                    if (calls.some(c => c.jobSold)) {
                        return i;
                    }
                }
                return 90;
            };

            const weeklyTotals = useMemo(() => 
                selectedPerson ? calculateTotals(selectedPerson, weekDates) : null,
                [selectedPerson, weekDates, callLogs]
            );

            const monthlyTotals = useMemo(() => 
                selectedPerson ? calculateTotals(selectedPerson, getMonthDates(currentDate)) : null,
                [selectedPerson, currentDate, callLogs]
            );

            const yearlyTotals = useMemo(() => 
                selectedPerson ? calculateTotals(selectedPerson, getYearDates(currentDate.getFullYear())) : null,
                [selectedPerson, currentDate, callLogs]
            );

            const allMemberStats = useMemo(() => {
                return salespeople.map(person => {
                    const monthStats = calculateTotals(person.id, getMonthDates(currentDate));
                    const weekStats = calculateTotals(person.id, weekDates);
                    const yearStats = calculateTotals(person.id, getYearDates(currentDate.getFullYear()));
                    const streak = getStreak(person.id);
                    const daysSinceSale = getDaysSinceLastSale(person.id);
                    return { 
                        ...person, 
                        ...monthStats,
                        weekRevenue: weekStats.amountSold,
                        yearRevenue: yearStats.amountSold,
                        streak,
                        daysSinceSale
                    };
                }).sort((a, b) => b.amountSold - a.amountSold);
            }, [salespeople, currentDate, weekDates, callLogs]);

            const teamWeeklyTotal = useMemo(() => {
                return allMemberStats.reduce((sum, member) => sum + member.weekRevenue, 0);
            }, [allMemberStats]);

            const teamMonthlyTotal = useMemo(() => {
                return allMemberStats.reduce((sum, member) => sum + member.amountSold, 0);
            }, [allMemberStats]);

            const teamYearlyTotal = useMemo(() => {
                return allMemberStats.reduce((sum, member) => sum + member.yearRevenue, 0);
            }, [allMemberStats]);

            const todayStats = useMemo(() => getTodayStats(), [salespeople, callLogs]);

            const topPerformerWeek = useMemo(() => {
                return [...allMemberStats].sort((a, b) => b.weekRevenue - a.weekRevenue)[0];
            }, [allMemberStats]);

            const updateMonthlyGoal = (personId, value) => {
                const key = `${personId}_${getMonthKey(currentDate)}`;
                database.ref(`monthlyGoals/${key}`).set(parseFloat(value) || 0);
            };

            const updateYearlyGoal = (personId, value) => {
                const key = `${personId}_${getYearKey(currentDate)}`;
                database.ref(`yearlyGoals/${key}`).set(parseFloat(value) || 0);
            };

            const getMonthlyGoal = (personId) => {
                const key = `${personId}_${getMonthKey(currentDate)}`;
                return monthlyGoals[key] || 0;
            };

            const getYearlyGoal = (personId) => {
                const key = `${personId}_${getYearKey(currentDate)}`;
                return yearlyGoals[key] || 0;
            };

            const updateTeamMonthlyGoal = (value) => {
                database.ref('teamMonthlyGoal').set(parseFloat(value) || 0);
            };

            const getBestDayOfWeek = (personId) => {
                const dayTotals = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                const year = currentDate.getFullYear();
                
                for (let month = 0; month < 12; month++) {
                    const monthDates = getMonthDates(new Date(year, month, 1));
                    monthDates.forEach(date => {
                        const calls = getCallLogs(personId, date);
                        const revenue = calls.reduce((sum, c) => sum + (parseFloat(c.amountSold) || 0), 0);
                        dayTotals[date.getDay()] += revenue;
                    });
                }
                
                const maxDay = Object.keys(dayTotals).reduce((a, b) => dayTotals[a] > dayTotals[b] ? a : b);
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[maxDay];
            };

            const getMonthlyForecast = (personId) => {
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const daysPassed = today.getDate();
                const monthStats = calculateTotals(personId, getMonthDates(today));
                const dailyAverage = monthStats.amountSold / daysPassed;
                return dailyAverage * daysInMonth;
            };
            // Create charts
            useEffect(() => {
                if (selectedPerson && weeklyTotals && dailyChartRef.current) {
                    const ctx = dailyChartRef.current.getContext('2d');
                    
                    if (dailyChartInstance.current) {
                        dailyChartInstance.current.destroy();
                    }

                    const labels = weekDates.map(d => d.toLocaleDateString('en-US', { weekday: 'short' }));
                    const data = weekDates.map(d => {
                        const dateKey = getDateKey(d);
                        return weeklyTotals.dailyBreakdown[dateKey]?.revenue || 0;
                    });

                    dailyChartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Daily Revenue',
                                data,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (dailyChartInstance.current) {
                        dailyChartInstance.current.destroy();
                    }
                };
            }, [selectedPerson, weeklyTotals, weekDates]);

            useEffect(() => {
                if (selectedPerson && monthlyTotals && tradeChartRef.current) {
                    const ctx = tradeChartRef.current.getContext('2d');
                    
                    if (tradeChartInstance.current) {
                        tradeChartInstance.current.destroy();
                    }

                    const data = [
                        monthlyTotals.tradePlumbing || 0,
                        monthlyTotals.tradeElectrical || 0,
                        monthlyTotals.tradeHVAC || 0,
                        monthlyTotals.tradeCameras || 0
                    ];

                    const total = data.reduce((a, b) => a + b, 0);
                    if (total > 0) {
                        tradeChartInstance.current = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Plumbing', 'Electrical', 'HVAC', 'Cameras'],
                                datasets: [{
                                    data,
                                    backgroundColor: [
                                        'rgba(59, 130, 246, 0.7)',
                                        'rgba(250, 204, 21, 0.7)',
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(168, 85, 247, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgb(59, 130, 246)',
                                        'rgb(250, 204, 21)',
                                        'rgb(239, 68, 68)',
                                        'rgb(168, 85, 247)'
                                    ],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                return () => {
                    if (tradeChartInstance.current) {
                        tradeChartInstance.current.destroy();
                    }
                };
            }, [selectedPerson, monthlyTotals]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-2xl font-bold text-blue-600">Loading...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto">
                        <h1 className="text-3xl font-bold mb-6 text-blue-900">üîß Action Plumbing Sales Tracker</h1>

                        {/* DASHBOARD SUMMARY */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                                <p className="text-sm font-semibold opacity-90">Today's Calls</p>
                                <p className="text-4xl font-bold">{todayStats.totalCalls}</p>
                                <p className="text-xs opacity-75 mt-1">All team members</p>
                            </div>
                            <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                                <p className="text-sm font-semibold opacity-90">Today's Revenue</p>
                                <p className="text-4xl font-bold">${todayStats.totalRevenue.toLocaleString()}</p>
                                <p className="text-xs opacity-75 mt-1">Team total</p>
                            </div>
                            <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                                <p className="text-sm font-semibold opacity-90">Week's Revenue</p>
                                <p className="text-4xl font-bold">${teamWeeklyTotal.toLocaleString()}</p>
                                <p className="text-xs opacity-75 mt-1">Last 7 days</p>
                            </div>
                            <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-lg shadow-lg">
                                <p className="text-sm font-semibold opacity-90">Top Performer</p>
                                <p className="text-2xl font-bold">{topPerformerWeek?.name || 'N/A'}</p>
                                <p className="text-xs opacity-75 mt-1">${(topPerformerWeek?.weekRevenue || 0).toLocaleString()} this week</p>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-lg mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-semibold">Sales Team</h2>
                                {!showAddPerson && (
                                    <button
                                        onClick={() => setShowAddPerson(true)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                                    >
                                        + Add Person
                                    </button>
                                )}
                            </div>

                            {showAddPerson && (
                                <div className="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={newPersonName}
                                            onChange={(e) => setNewPersonName(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && addSalesperson()}
                                            placeholder="Enter salesperson name"
                                            className="flex-1 px-4 py-2 border-2 rounded-lg"
                                            autoFocus
                                        />
                                        <button onClick={addSalesperson} className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Add</button>
                                        <button onClick={() => { setShowAddPerson(false); setNewPersonName(''); }} className="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 font-semibold">Cancel</button>
                                    </div>
                                </div>
                            )}

                            {salespeople.length === 0 ? (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <p className="text-xl text-gray-500">No salespeople added yet</p>
                                </div>
                            ) : (
                                <div className="flex flex-wrap gap-3">
                                    {salespeople.map((person) => {
                                        const personStats = allMemberStats.find(m => m.id === person.id);
                                        const streak = personStats?.streak || 0;
                                        const daysSinceSale = personStats?.daysSinceSale || 0;
                                        
                                        return (
                                            <div key={person.id} className="relative group">
                                                <button
                                                    onClick={() => setSelectedPerson(person.id)}
                                                    className={`px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                                                        selectedPerson === person.id
                                                            ? 'bg-blue-600 text-white shadow-lg'
                                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {person.name}
                                                    {streak >= 3 && <span className="ml-2">üî•</span>}
                                                    {daysSinceSale > 7 && <span className="ml-2">‚ùÑÔ∏è</span>}
                                                </button>
                                                <button
                                                    onClick={() => removeSalesperson(person.id)}
                                                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100"
                                                >
                                                    √ó
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        {selectedPerson && (
                            <>
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-lg border-2 border-blue-300 mb-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <button 
                                            onClick={() => setCurrentDate(new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000))}
                                            className="p-3 bg-white rounded-full hover:bg-blue-100 shadow font-bold text-xl"
                                        >
                                            ‚Üê
                                        </button>
                                        <h2 className="text-xl font-bold text-blue-900">
                                            {weekDates[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {weekDates[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                        </h2>
                                        <button 
                                            onClick={() => setCurrentDate(new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000))}
                                            className="p-3 bg-white rounded-full hover:bg-blue-100 shadow font-bold text-xl"
                                        >
                                            ‚Üí
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-7 gap-3">
                                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => (
                                            <div key={day} className="text-center text-sm font-bold text-blue-700 mb-2">{day}</div>
                                        ))}
                                        {weekDates.map((date, idx) => {
                                            const calls = getCallLogs(selectedPerson, date);
                                            const sold = calls.filter(c => c.jobSold);
                                            const total = calls.reduce((sum, c) => sum + (parseFloat(c.amountSold) || 0), 0);
                                            const dateKey = getDateKey(date);
                                            const isToday = getDateKey(new Date()) === dateKey;
                                            
                                            return (
                                                <button
                                                    key={idx}
                                                    onClick={() => setSelectedDate(selectedDate === dateKey ? null : dateKey)}
                                                    className={`p-4 rounded-xl border-2 transition-all ${
                                                        selectedDate === dateKey 
                                                            ? 'border-blue-600 bg-blue-100 shadow-lg' 
                                                            : calls.length > 0 
                                                                ? 'border-green-400 bg-green-50 hover:shadow-md' 
                                                                : isToday 
                                                                    ? 'border-blue-300 bg-white shadow-md'
                                                                    : 'border-gray-200 bg-white hover:border-gray-300'
                                                    }`}
                                                >
                                                    <div className="text-xl font-bold">{date.getDate()}</div>
                                                    {calls.length > 0 && (
                                                        <div className="mt-2">
                                                            <div className="text-xs font-bold text-green-700">{sold.length} sold</div>
                                                            <div className="text-xs font-bold text-green-700">${total.toLocaleString()}</div>
                                                        </div>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {selectedDate && (
                                    <div className="bg-white p-6 rounded-lg shadow-lg mb-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-2xl font-bold text-blue-900">üìû Call Logs</h3>
                                            <button
                                                onClick={() => addCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate))}
                                                className="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold"
                                            >
                                                + Add Call
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-4 max-h-[600px] overflow-y-auto">
                                            {getCallLogs(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate)).map(call => {
                                                const amountOwed = (parseFloat(call.amountSold) || 0) - (parseFloat(call.amountCollected) || 0);
                                                
                                                return (
                                                    <div key={call.id} className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                                                        <div className="flex justify-between mb-3">
                                                            <span className="text-sm font-bold text-gray-600">Call Entry</span>
                                                            <button 
                                                                onClick={() => deleteCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id)}
                                                                className="text-red-600 font-bold hover:text-red-800"
                                                            >
                                                                üóëÔ∏è Delete
                                                            </button>
                                                        </div>
                                                        
                                                        <div className="space-y-3">
                                                            <input
                                                                type="text"
                                                                value={call.customerName || ''}
                                                                onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'customerName', e.target.value)}
                                                                className="w-full px-3 py-2 border-2 rounded-lg"
                                                                placeholder="Customer Name"
                                                            />
                                                            
                                                            <input
                                                                type="text"
                                                                value={call.jobNumber || ''}
                                                                onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'jobNumber', e.target.value)}
                                                                className="w-full px-3 py-2 border-2 rounded-lg"
                                                                placeholder="Job Number"
                                                            />

                                                            <label className="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-gray-300 cursor-pointer hover:border-green-400">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={call.jobSold || false}
                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'jobSold', e.target.checked)}
                                                                    className="w-5 h-5"
                                                                />
                                                                <span className="font-bold text-lg">üí∞ Job Sold</span>
                                                            </label>

                                                            {call.jobSold && (
                                                                <div className="space-y-2">
                                                                    <div>
                                                                        <label className="text-sm font-bold text-gray-700 mb-1 block">Amount Sold</label>
                                                                        <input
                                                                            type="number"
                                                                            value={call.amountSold || ''}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'amountSold', parseFloat(e.target.value) || 0)}
                                                                            className="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-lg font-bold"
                                                                            placeholder="Amount Sold ($)"
                                                                        />
                                                                    </div>
                                                                    
                                                                    <div>
                                                                        <label className="text-sm font-bold text-gray-700 mb-1 block">Total Collected</label>
                                                                        <input
                                                                            type="number"
                                                                            value={call.amountCollected || ''}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'amountCollected', parseFloat(e.target.value) || 0)}
                                                                            className="w-full px-3 py-2 border-2 border-blue-300 rounded-lg font-bold"
                                                                            placeholder="Total Collected ($)"
                                                                        />
                                                                    </div>
                                                                    
                                                                    <div className="bg-orange-100 border-2 border-orange-400 rounded-lg p-4">
                                                                        <label className="text-sm font-bold text-gray-700 mb-1 block">Amount Due</label>
                                                                        <p className="text-3xl font-bold text-orange-900">${amountOwed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                                                    </div>
                                                                    
                                                                    <div className="border-t-2 pt-3 mt-3">
                                                                        <p className="font-bold text-sm text-gray-700 mb-2">Form of Payment</p>
                                                                        <div className="grid grid-cols-2 gap-2">
                                                                            <label className="flex items-center gap-2 p-2 bg-blue-50 rounded border border-blue-300 cursor-pointer">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={call.paymentFinancing || false}
                                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'paymentFinancing', e.target.checked)}
                                                                                    className="w-4 h-4"
                                                                                />
                                                                                <span className="text-sm font-bold text-blue-700">üí≥ Financing</span>
                                                                            </label>
                                                                            <label className="flex items-center gap-2 p-2 bg-green-50 rounded border border-green-300 cursor-pointer">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={call.paymentCash || false}
                                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'paymentCash', e.target.checked)}
                                                                                    className="w-4 h-4"
                                                                                />
                                                                                <span className="text-sm font-bold text-green-700">üíµ Cash</span>
                                                                            </label>
                                                                            <label className="flex items-center gap-2 p-2 bg-yellow-50 rounded border border-yellow-300 cursor-pointer">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={call.paymentCheck || false}
                                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'paymentCheck', e.target.checked)}
                                                                                    className="w-4 h-4"
                                                                                />
                                                                                <span className="text-sm font-bold text-yellow-700">‚úÖ Check</span>
                                                                            </label>
                                                                            <label className="flex items-center gap-2 p-2 bg-purple-50 rounded border border-purple-300 cursor-pointer">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    checked={call.paymentCreditCard || false}
                                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'paymentCreditCard', e.target.checked)}
                                                                                    className="w-4 h-4"
                                                                                />
                                                                                <span className="text-sm font-bold text-purple-700">üí≥ Credit Card</span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <label className="flex items-center gap-3 p-3 bg-white rounded-lg border-2 border-gray-300 cursor-pointer hover:border-orange-400">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={call.leftEstimate || false}
                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'leftEstimate', e.target.checked)}
                                                                    className="w-5 h-5"
                                                                />
                                                                <span className="font-bold">üìã Left Estimate</span>
                                                            </label>

                                                            {call.leftEstimate && (
                                                                <input
                                                                    type="number"
                                                                    value={call.estimateAmount || ''}
                                                                    onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'estimateAmount', parseFloat(e.target.value) || 0)}
                                                                    className="w-full px-3 py-2 border-2 border-orange-300 rounded-lg"
                                                                    placeholder="Estimate Amount ($)"
                                                                />
                                                            )}
                                                            <div className="border-t-2 pt-3 mt-3">
                                                                <p className="font-bold text-sm text-gray-700 mb-2">Trade Type</p>
                                                                <div className="grid grid-cols-2 gap-2">
                                                                    <label className="flex items-center gap-2 p-2 bg-blue-50 rounded border border-blue-300 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.tradePlumbing || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'tradePlumbing', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span className="text-sm font-bold text-blue-700">üîß Plumbing</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 p-2 bg-yellow-50 rounded border border-yellow-300 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.tradeElectrical || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'tradeElectrical', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span className="text-sm font-bold text-yellow-700">‚ö° Electrical</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 p-2 bg-red-50 rounded border border-red-300 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.tradeHVAC || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'tradeHVAC', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span className="text-sm font-bold text-red-700">üå°Ô∏è HVAC</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 p-2 bg-purple-50 rounded border border-purple-300 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.tradeCameras || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'tradeCameras', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span className="text-sm font-bold text-purple-700">üìπ Cameras</span>
                                                                    </label>
                                                                </div>
                                                            </div>

                                                            <div className="border-t-2 pt-3 mt-3">
                                                                <p className="font-bold text-sm text-gray-700 mb-2">Performance Metrics</p>
                                                                <div className="grid grid-cols-2 gap-2">
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.reviewCompleted || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'reviewCompleted', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>‚úÖ Review Completed</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.restorationLead || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'restorationLead', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>üè† Restoration Lead</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.turnoverAttempted || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'turnoverAttempted', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>üîÑ Turnover Attempted</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.turnoverAccepted || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'turnoverAccepted', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                            disabled={!call.turnoverAttempted}
                                                                        />
                                                                        <span>‚úîÔ∏è Turnover Accepted</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.selfGeneratedLead || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'selfGeneratedLead', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>üéØ Self-Generated Lead</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.stickers || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'stickers', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>üè∑Ô∏è Stickers</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.maintenancePlanSold || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'maintenancePlanSold', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>üõ°Ô∏è Maintenance Plan Sold</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.upsellCompleted || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'upsellCompleted', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>‚¨ÜÔ∏è Upsell Completed</span>
                                                                    </label>
                                                                    <label className="flex items-center gap-2 text-sm cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={call.jobComplete || false}
                                                                            onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'jobComplete', e.target.checked)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>‚úîÔ∏è Job Complete</span>
                                                                    </label>
                                                                </div>

                                                                {call.upsellCompleted && (
                                                                    <input
                                                                        type="number"
                                                                        value={call.upsellAmount || ''}
                                                                        onChange={(e) => updateCall(selectedPerson, weekDates.find(d => getDateKey(d) === selectedDate), call.id, 'upsellAmount', parseFloat(e.target.value) || 0)}
                                                                        className="w-full px-3 py-2 border-2 rounded-lg mt-2"
                                                                        placeholder="Upsell Amount ($)"
                                                                    />
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {/* OUTSTANDING JOBS DROPDOWN */}
                                {monthlyTotals && monthlyTotals.moneyOwed > 0 && (
                                    <div className="bg-gradient-to-br from-red-50 to-orange-50 p-6 rounded-lg shadow-lg border-2 border-red-300 mb-6">
                                        <button
                                            onClick={() => setShowOutstandingJobs(!showOutstandingJobs)}
                                            className="w-full flex items-center justify-between"
                                        >
                                            <div className="flex items-center gap-2">
                                                <span className="text-xl font-bold text-red-900">üí∞ Outstanding Jobs - Money Owed</span>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="text-2xl font-bold text-red-900">${monthlyTotals.moneyOwed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                                <span className="text-2xl">{showOutstandingJobs ? '‚ñº' : '‚ñ∂'}</span>
                                            </div>
                                        </button>

                                        {showOutstandingJobs && (
                                            <div className="mt-4 space-y-3">
                                                {monthlyTotals.outstandingJobs.map((job, idx) => (
                                                    <div key={idx} className="bg-white p-4 rounded-lg border-2 border-red-200">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <p className="font-bold text-lg text-gray-900">{job.customerName}</p>
                                                                <p className="text-sm text-gray-600">Job #: {job.jobNumber}</p>
                                                                <p className="text-sm text-gray-600">{job.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="text-2xl font-bold text-red-600">${job.amountOwed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                                                <p className="text-xs text-gray-500">owed</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex justify-between text-sm text-gray-600 pt-2 border-t">
                                                            <span>Sold: ${job.amountSold.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                                            <span>Collected: ${job.amountCollected.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                <div className="bg-gradient-to-r from-red-600 to-red-700 text-white p-4 rounded-lg">
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <p className="text-xl font-bold">Total Outstanding Balance</p>
                                                            <p className="text-sm opacity-90">{monthlyTotals.outstandingJobs.length} job{monthlyTotals.outstandingJobs.length !== 1 ? 's' : ''} with outstanding balances</p>
                                                        </div>
                                                        <p className="text-3xl font-bold">${monthlyTotals.moneyOwed.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                    <div className="bg-white p-6 rounded-lg shadow-lg">
                                        <h2 className="text-2xl font-bold mb-4 text-blue-900">
                                            üìä Weekly Performance
                                        </h2>
                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                            <div className="p-3 bg-blue-50 rounded border-2 border-blue-300">
                                                <p className="text-xs font-bold text-blue-700">Total Calls</p>
                                                <p className="text-2xl font-bold text-blue-900">{weeklyTotals?.totalCalls || 0}</p>
                                            </div>
                                            <div className="p-3 bg-green-50 rounded border-2 border-green-300">
                                                <p className="text-xs font-bold text-green-700">Calls Sold</p>
                                                <p className="text-2xl font-bold text-green-900">{weeklyTotals?.callsSold || 0}</p>
                                            </div>
                                            <div className="p-3 bg-purple-50 rounded border-2 border-purple-300">
                                                <p className="text-xs font-bold text-purple-700">Revenue</p>
                                                <p className="text-2xl font-bold text-purple-900">${(weeklyTotals?.amountSold || 0).toLocaleString()}</p>
                                            </div>
                                            <div className="p-3 bg-orange-50 rounded border-2 border-orange-300">
                                                <p className="text-xs font-bold text-orange-700">Money Owed</p>
                                                <p className="text-2xl font-bold text-orange-900">${(weeklyTotals?.moneyOwed || 0).toLocaleString()}</p>
                                            </div>
                                        </div>

                                        <div className="mb-4">
                                            <h3 className="font-bold text-sm mb-2">Daily Revenue Chart</h3>
                                            <div style={{ height: '200px' }}>
                                                <canvas ref={dailyChartRef}></canvas>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-sm mb-2">Key Metrics</h3>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between">
                                                    <span>Closing Rate:</span>
                                                    <span className="font-bold">{weeklyTotals?.totalCalls > 0 ? ((weeklyTotals.callsSold / weeklyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Streak:</span>
                                                    <span className="font-bold">{getStreak(selectedPerson)} days {getStreak(selectedPerson) >= 3 ? 'üî•' : ''}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Days Since Last Sale:</span>
                                                    <span className={`font-bold ${getDaysSinceLastSale(selectedPerson) > 7 ? 'text-red-600' : 'text-green-600'}`}>
                                                        {getDaysSinceLastSale(selectedPerson)} days
                                                    </span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Best Day:</span>
                                                    <span className="font-bold">{getBestDayOfWeek(selectedPerson)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-lg shadow-lg">
                                        <h2 className="text-2xl font-bold mb-4 text-blue-900">
                                            üìà Monthly Stats - {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </h2>
                                        <div className="grid grid-cols-2 gap-3 mb-4">
                                            <div className="p-3 bg-blue-50 rounded border-2 border-blue-300">
                                                <p className="text-xs font-bold text-blue-700">Total Calls</p>
                                                <p className="text-2xl font-bold text-blue-900">{monthlyTotals?.totalCalls || 0}</p>
                                            </div>
                                            <div className="p-3 bg-green-50 rounded border-2 border-green-300">
                                                <p className="text-xs font-bold text-green-700">Calls Sold</p>
                                                <p className="text-2xl font-bold text-green-900">{monthlyTotals?.callsSold || 0}</p>
                                            </div>
                                            <div className="p-3 bg-purple-50 rounded border-2 border-purple-300">
                                                <p className="text-xs font-bold text-purple-700">Revenue</p>
                                                <p className="text-2xl font-bold text-purple-900">${(monthlyTotals?.amountSold || 0).toLocaleString()}</p>
                                            </div>
                                            <div className="p-3 bg-orange-50 rounded border-2 border-orange-300">
                                                <p className="text-xs font-bold text-orange-700">Money Owed</p>
                                                <p className="text-2xl font-bold text-orange-900">${(monthlyTotals?.moneyOwed || 0).toLocaleString()}</p>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-blue-50 rounded border-2 border-blue-300 mb-4">
                                            <h3 className="font-bold mb-2">Monthly Sales Goal</h3>
                                            <input
                                                type="number"
                                                value={getMonthlyGoal(selectedPerson) || ''}
                                                onChange={(e) => updateMonthlyGoal(selectedPerson, e.target.value)}
                                                className="w-full px-3 py-2 border-2 rounded-lg mb-2"
                                                placeholder="Set Goal ($)"
                                            />
                                            {getMonthlyGoal(selectedPerson) > 0 && (
                                                <div className="space-y-2">
                                                    <div className="flex justify-between text-sm">
                                                        <span>Progress:</span>
                                                        <span className="font-bold">{((monthlyTotals?.amountSold / getMonthlyGoal(selectedPerson)) * 100).toFixed(1)}%</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-6">
                                                        <div 
                                                            className={`h-full rounded-full flex items-center justify-center text-white text-xs font-bold ${
                                                                (monthlyTotals?.amountSold / getMonthlyGoal(selectedPerson)) >= 1 ? 'bg-green-600' :
                                                                (monthlyTotals?.amountSold / getMonthlyGoal(selectedPerson)) >= 0.5 ? 'bg-yellow-500' :
                                                                'bg-red-500'
                                                            }`}
                                                            style={{ width: `${Math.min((monthlyTotals?.amountSold / getMonthlyGoal(selectedPerson)) * 100, 100)}%` }}
                                                        >
                                                            {((monthlyTotals?.amountSold / getMonthlyGoal(selectedPerson)) * 100).toFixed(0)}%
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2 text-sm pt-2">
                                                        <div>
                                                            <p className="text-xs text-gray-600">Sold</p>
                                                            <p className="font-bold">${(monthlyTotals?.amountSold || 0).toLocaleString()}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-600">Goal</p>
                                                            <p className="font-bold">${getMonthlyGoal(selectedPerson).toLocaleString()}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-gray-600">Remaining</p>
                                                            <p className="font-bold text-orange-600">${Math.max(0, getMonthlyGoal(selectedPerson) - (monthlyTotals?.amountSold || 0)).toLocaleString()}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="p-4 bg-indigo-50 rounded border-2 border-indigo-300 mb-4">
                                            <h3 className="font-bold mb-2 text-sm">Monthly Forecast</h3>
                                            <p className="text-xs text-gray-600 mb-1">Based on current daily average</p>
                                            <p className="text-2xl font-bold text-indigo-900">${getMonthlyForecast(selectedPerson).toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                                        </div>

                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-sm mb-2">Monthly Performance</h3>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between">
                                                    <span>Closing Rate:</span>
                                                    <span className="font-bold">{monthlyTotals?.totalCalls > 0 ? ((monthlyTotals.callsSold / monthlyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Call Average:</span>
                                                    <span className="font-bold">${monthlyTotals?.callsSold > 0 ? (monthlyTotals.amountSold / monthlyTotals.callsSold).toLocaleString(undefined, {maximumFractionDigits: 0}) : 0}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Review Rate:</span>
                                                    <span className="font-bold">{monthlyTotals?.totalCalls > 0 ? ((monthlyTotals.reviewsCompleted / monthlyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Membership Rate:</span>
                                                    <span className="font-bold">{monthlyTotals?.callsSold > 0 ? ((monthlyTotals.plansSold / monthlyTotals.callsSold) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Upsell Rate:</span>
                                                    <span className="font-bold">{monthlyTotals?.callsSold > 0 ? ((monthlyTotals.upsellsCompleted / monthlyTotals.callsSold) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-lg mb-6">
                                    <h2 className="text-2xl font-bold mb-4 text-purple-900">
                                        üèÜ {currentDate.getFullYear()} Yearly Performance
                                    </h2>
                                    <div className="grid grid-cols-4 gap-3 mb-4">
                                        <div className="p-3 bg-blue-50 rounded border-2 border-blue-300">
                                            <p className="text-xs font-bold text-blue-700">Total Calls</p>
                                            <p className="text-2xl font-bold text-blue-900">{yearlyTotals?.totalCalls || 0}</p>
                                        </div>
                                        <div className="p-3 bg-green-50 rounded border-2 border-green-300">
                                            <p className="text-xs font-bold text-green-700">Total Sold</p>
                                            <p className="text-2xl font-bold text-green-900">{yearlyTotals?.callsSold || 0}</p>
                                        </div>
                                        <div className="p-3 bg-purple-50 rounded border-2 border-purple-300">
                                            <p className="text-xs font-bold text-purple-700">Revenue</p>
                                            <p className="text-2xl font-bold text-purple-900">${(yearlyTotals?.amountSold || 0).toLocaleString()}</p>
                                        </div>
                                        <div className="p-3 bg-orange-50 rounded border-2 border-orange-300">
                                            <p className="text-xs font-bold text-orange-700">Money Owed</p>
                                            <p className="text-2xl font-bold text-orange-900">${(yearlyTotals?.moneyOwed || 0).toLocaleString()}</p>
                                        </div>
                                    </div>

                                    <div className="p-4 bg-purple-50 rounded border-2 border-purple-300 mb-4">
                                        <h3 className="font-bold mb-2">Yearly Sales Goal - {currentDate.getFullYear()}</h3>
                                        <input
                                            type="number"
                                            value={getYearlyGoal(selectedPerson) || ''}
                                            onChange={(e) => updateYearlyGoal(selectedPerson, e.target.value)}
                                            className="w-full px-3 py-2 border-2 rounded-lg mb-2"
                                            placeholder="Set Yearly Goal ($)"
                                        />
                                        {getYearlyGoal(selectedPerson) > 0 && (
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span>Progress:</span>
                                                    <span className="font-bold">{((yearlyTotals?.amountSold / getYearlyGoal(selectedPerson)) * 100).toFixed(1)}%</span>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-6">
                                                    <div 
                                                        className={`h-full rounded-full flex items-center justify-center text-white text-xs font-bold ${
                                                            (yearlyTotals?.amountSold / getYearlyGoal(selectedPerson)) >= 1 ? 'bg-green-600' :
                                                            (yearlyTotals?.amountSold / getYearlyGoal(selectedPerson)) >= 0.5 ? 'bg-yellow-500' :
                                                            'bg-red-500'
                                                        }`}
                                                        style={{ width: `${Math.min((yearlyTotals?.amountSold / getYearlyGoal(selectedPerson)) * 100, 100)}%` }}
                                                    >
                                                        {((yearlyTotals?.amountSold / getYearlyGoal(selectedPerson)) * 100).toFixed(0)}%
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-3 gap-2 text-sm pt-2">
                                                    <div>
                                                        <p className="text-xs text-gray-600">Sold So Far</p>
                                                        <p className="font-bold">${(yearlyTotals?.amountSold || 0).toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-gray-600">Goal</p>
                                                        <p className="font-bold">${getYearlyGoal(selectedPerson).toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-gray-600">Left to Goal</p>
                                                        <p className="font-bold text-orange-600">${Math.max(0, getYearlyGoal(selectedPerson) - (yearlyTotals?.amountSold || 0)).toLocaleString()}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-sm mb-3">Trade Distribution</h3>
                                            <div style={{ height: '200px' }}>
                                                <canvas ref={tradeChartRef}></canvas>
                                            </div>
                                            <div className="mt-3 space-y-1 text-sm">
                                                {monthlyTotals && (
                                                    <>
                                                        {(() => {
                                                            const total = (monthlyTotals.tradePlumbing || 0) + (monthlyTotals.tradeElectrical || 0) + (monthlyTotals.tradeHVAC || 0) + (monthlyTotals.tradeCameras || 0);
                                                            if (total === 0) return null;
                                                            return (
                                                                <>
                                                                    <div className="flex justify-between">
                                                                        <span className="flex items-center gap-2">
                                                                            <span className="w-3 h-3 bg-blue-500 rounded"></span>
                                                                            Plumbing
                                                                        </span>
                                                                        <span className="font-bold">{monthlyTotals.tradePlumbing || 0} ({((monthlyTotals.tradePlumbing || 0) / total * 100).toFixed(1)}%)</span>
                                                                    </div>
                                                                    <div className="flex justify-between">
                                                                        <span className="flex items-center gap-2">
                                                                            <span className="w-3 h-3 bg-yellow-400 rounded"></span>
                                                                            Electrical
                                                                        </span>
                                                                        <span className="font-bold">{monthlyTotals.tradeElectrical || 0} ({((monthlyTotals.tradeElectrical || 0) / total * 100).toFixed(1)}%)</span>
                                                                    </div>
                                                                    <div className="flex justify-between">
                                                                        <span className="flex items-center gap-2">
                                                                            <span className="w-3 h-3 bg-red-500 rounded"></span>
                                                                            HVAC
                                                                        </span>
                                                                        <span className="font-bold">{monthlyTotals.tradeHVAC || 0} ({((monthlyTotals.tradeHVAC || 0) / total * 100).toFixed(1)}%)</span>
                                                                    </div>
                                                                    <div className="flex justify-between">
                                                                        <span className="flex items-center gap-2">
                                                                            <span className="w-3 h-3 bg-purple-500 rounded"></span>
                                                                            Cameras
                                                                        </span>
                                                                        <span className="font-bold">{monthlyTotals.tradeCameras || 0} ({((monthlyTotals.tradeCameras || 0) / total * 100).toFixed(1)}%)</span>
                                                                    </div>
                                                                </>
                                                            );
                                                        })()}
                                                    </>
                                                )}
                                            </div>
                                        </div>

                                        <div className="p-4 bg-gray-50 rounded border">
                                            <h3 className="font-bold text-sm mb-3">Performance Metrics</h3>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between">
                                                    <span>Closing Rate:</span>
                                                    <span className="font-bold">{yearlyTotals?.totalCalls > 0 ? ((yearlyTotals.callsSold / yearlyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Reviews Rate:</span>
                                                    <span className="font-bold">{yearlyTotals?.totalCalls > 0 ? ((yearlyTotals.reviewsCompleted / yearlyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Turnover Rate:</span>
                                                    <span className="font-bold">{yearlyTotals?.turnoversAttempted > 0 ? ((yearlyTotals.turnoversAccepted / yearlyTotals.turnoversAttempted) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Stickers:</span>
                                                    <span className="font-bold">{yearlyTotals?.totalCalls > 0 ? ((yearlyTotals.stickers / yearlyTotals.totalCalls) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Plans Sold:</span>
                                                    <span className="font-bold">{yearlyTotals?.plansSold || 0}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Restoration Leads:</span>
                                                    <span className="font-bold">{yearlyTotals?.restorationLeads || 0}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span>Upsell Rate:</span>
                                                    <span className="font-bold">{yearlyTotals?.callsSold > 0 ? ((yearlyTotals.upsellsCompleted / yearlyTotals.callsSold) * 100).toFixed(1) : 0}%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-lg shadow-lg border-2 border-indigo-300 mb-6">
                                    <h2 className="text-2xl font-bold mb-4 text-indigo-900">üë• Team Performance</h2>

                                    <div className="bg-white p-4 rounded-lg border-2 border-blue-400 mb-4">
                                        <h3 className="font-bold mb-3">Team Monthly Goal</h3>
                                        <div className="grid grid-cols-2 gap-4 mb-2">
                                            <input
                                                type="number"
                                                value={teamMonthlyGoal || ''}
                                                onChange={(e) => updateTeamMonthlyGoal(e.target.value)}
                                                className="px-3 py-2 border-2 rounded-lg"
                                                placeholder="Set Team Goal ($)"
                                            />
                                            <div className="bg-blue-50 p-3 rounded">
                                                <p className="text-sm font-bold">Team Sold: ${teamMonthlyTotal.toLocaleString()}</p>
                                                {teamMonthlyGoal > 0 && (
                                                    <p className="text-sm">Progress: {((teamMonthlyTotal / teamMonthlyGoal) * 100).toFixed(1)}%</p>
                                                )}
                                            </div>
                                        </div>
                                        {teamMonthlyGoal > 0 && (
                                            <div className="w-full bg-gray-200 rounded-full h-6">
                                                <div 
                                                    className={`h-full rounded-full flex items-center justify-center text-white text-xs font-bold ${
                                                        (teamMonthlyTotal / teamMonthlyGoal) >= 1 ? 'bg-green-600' :
                                                        (teamMonthlyTotal / teamMonthlyGoal) >= 0.5 ? 'bg-yellow-500' :
                                                        'bg-red-500'
                                                    }`}
                                                    style={{ width: `${Math.min((teamMonthlyTotal / teamMonthlyGoal) * 100, 100)}%` }}
                                                >
                                                    {((teamMonthlyTotal / teamMonthlyGoal) * 100).toFixed(0)}%
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="bg-white p-4 rounded-lg border mb-4">
                                        <h3 className="font-bold mb-3">Individual Monthly Goals</h3>
                                        <div className="space-y-2">
                                            {allMemberStats.map(member => {
                                                const goal = getMonthlyGoal(member.id);
                                                const progress = goal > 0 ? (member.amountSold / goal) * 100 : 0;
                                                return (
                                                    <div key={member.id} className="p-3 bg-gray-50 rounded border">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <div>
                                                                <p className="font-bold">{member.name}</p>
                                                                <p className="text-xs text-gray-600">Goal: ${goal.toLocaleString()}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="font-bold text-lg">${member.amountSold.toLocaleString()}</p>
                                                                {goal > 0 && <p className="text-sm text-gray-600">{progress.toFixed(1)}%</p>}
                                                            </div>
                                                        </div>
                                                        {goal > 0 && (
                                                            <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                                <div 
                                                                    className={`h-full rounded-full ${
                                                                        progress >= 100 ? 'bg-green-600' :
                                                                        progress >= 50 ? 'bg-yellow-500' :
                                                                        'bg-red-500'
                                                                    }`}
                                                                    style={{ width: `${Math.min(progress, 100)}%` }}
                                                                ></div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-white p-4 rounded-lg border">
                                        <h3 className="font-bold mb-3">Team Member Contributions</h3>
                                        <div className="space-y-2">
                                            {allMemberStats.map(member => {
                                                const closeRate = member.totalCalls > 0 ? (member.callsSold / member.totalCalls) * 100 : 0;
                                                const teamPercent = teamMonthlyTotal > 0 ? (member.amountSold / teamMonthlyTotal) * 100 : 0;
                                                return (
                                                    <div key={member.id} className="p-3 bg-gray-50 rounded border">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="font-bold">{member.name}</span>
                                                            <span className="font-bold text-lg">${member.amountSold.toLocaleString()}</span>
                                                        </div>
                                                        <div className="text-xs text-gray-600">
                                                            {member.callsSold} sales from {member.totalCalls} calls ‚Ä¢ {closeRate.toFixed(1)}% close rate ‚Ä¢ {teamPercent.toFixed(1)}% of team
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-lg shadow-lg border-2 border-yellow-400">
                                    <h2 className="text-2xl font-bold mb-4 text-yellow-900">üèÜ {currentDate.getFullYear()} Leaderboard</h2>
                                    <div className="space-y-3">
                                        {salespeople.map((person) => {
                                            const yearStats = calculateTotals(person.id, getYearDates(currentDate.getFullYear()));
                                            return { ...person, ...yearStats };
                                        })
                                        .sort((a, b) => b.amountSold - a.amountSold)
                                        .map((person, idx) => {
                                            const closeRate = person.totalCalls > 0 ? (person.callsSold / person.totalCalls) * 100 : 0;
                                            const medals = ['ü•á', 'ü•à', 'ü•â'];
                                            const titles = ['üëë Top Performer', '‚≠ê Runner Up', 'üéØ Bronze'];
                                            const streak = getStreak(person.id);
                                            
                                            return (
                                                <div key={person.id} className={`p-4 rounded-lg border-2 ${
                                                    idx === 0 ? 'bg-yellow-100 border-yellow-400' :
                                                    idx === 1 ? 'bg-gray-100 border-gray-400' :
                                                    idx === 2 ? 'bg-orange-100 border-orange-400' :
                                                    'bg-white border-gray-300'
                                                }`}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-2xl">{idx < 3 ? medals[idx] : `#${idx + 1}`}</span>
                                                            <div>
                                                                <p className="font-bold text-lg">
                                                                    {person.name} 
                                                                    {streak >= 3 && <span className="ml-2">üî•</span>}
                                                                </p>
                                                                {idx < 3 && <p className="text-xs text-gray-600">{titles[idx]}</p>}
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-sm text-gray-600">Total Sold</p>
                                                            <p className="font-bold text-xl">${person.amountSold.toLocaleString()}</p>
                                                            <p className="text-xs text-gray-600">Close Rate: {closeRate.toFixed(1)}%</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
